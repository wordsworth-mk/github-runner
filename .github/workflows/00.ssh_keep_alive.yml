# é»˜è®¤å·¥ä½œè·¯å¾„æ˜¯åœ¨ $GITHUB_WORKSPACE è·¯å¾„ä¸‹ å³ /home/runner/work/github-runner/github-runner
# é»˜è®¤æ˜¯ docker ç»„ä¸‹çš„ runner ç”¨æˆ·
# https://zhuanlan.zhihu.com/p/387389708?utm_id=0
# https://github.com/marketplace/actions/debugging-with-tmate
# https://github.com/marketplace/actions/debugging-with-ssh

name: 00. ğŸ‰ ssh_keep_alive

on:
  workflow_dispatch:
    inputs:
      SYSTEM:
        type: choice
        description: "ç³»ç»Ÿ"
        required: false
        default: ubuntu-latest
        options:
          - windows-latest
          - ubuntu-latest

      SETUP_KIND:
        type: boolean
        description: "å®‰è£… kind"
        required: false
        default: false

      SSH_WITH_VSCODE:
        type: choice
        description: "true åˆ™åªå¼€å¯ SSH, false åˆ™å¼€å¯ vscode"
        required: false
        default: "true"
        options:
          - "true"
          - "false"

      FREE_DISK:
        type: boolean
        description: "é‡Šæ”¾ç£ç›˜ç©ºé—´"
        required: false
        default: false

      PYTHON_VERSION:
        type: choice
        description: "python ç‰ˆæœ¬"
        default: "3.9"
        options:
          - "3.9"
          - "3.10"

  # # å®šæ—¶æ‰§è¡Œ
  # schedule:
  #   # ä»£è¡¨å›½é™…æ ‡å‡†æ—¶é—´ï¼Œå®é™…åŒ—äº¬æ—¶é—´éœ€è¦ +8 å°æ—¶
  #   - cron: "30 01 * * *"
  #   - cron: "30 07 * * *"

  # è¯¥äº‹ä»¶å¯ä»¥é€šè¿‡ API è§¦å‘
  repository_dispatch:
    types:
      - ssh_keep_alive

env:
  FONT_DIR: mypy/mypy/assets/font
  ENV_INIT_SCRIPT: mypy/env_init.sh
  DEPENDENT_BINARY: "ffmpeg libreoffice poppler-utils wkhtmltopdf"
  ENV_IN_GITHUBACTION: true

jobs:
  start_ssh:
    # NOTICE: æ³¨æ„è¿™é‡Œè¦ç”¨å•å¼•å·
    runs-on: ${{ inputs.SYSTEM || 'ubuntu-latest' }}
    steps:
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        # runner.os == 'Linux' / 'Windows' è¦ç”¨å•å¼•å·
        if: ${{ inputs.FREE_DISK && runner.os == 'Linux' }}
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: æ¸…ç†ç£ç›˜
        if: ${{ inputs.FREE_DISK && runner.os == 'Linux' }}
        continue-on-error: true # å³ä½¿å¤±è´¥äº†ä¹Ÿç»§ç»­åç»­æµç¨‹
        run: |
          echo "================================="
          echo "-----> ç£ç›˜æ¸…ç†å‰ <-----"
          df -h
          echo "================================="

          docker rmi `docker images -q` > /dev/null 2>&1 || true
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php > /dev/null 2>&1
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* > /dev/null 2>&1 || true
          sudo -E apt-get -qq update > /dev/null 2>&1
          sudo -E apt-get -qq autoremove --purge > /dev/null 2>&1
          sudo -E apt-get -qq clean > /dev/null 2>&1

          # sudo find /opt/hostedtoolcache/* -maxdepth 1 -type d ! -name "Python" -exec rm -rf {} \; > /dev/null 2>&1
          # sudo -rf /usr/local/.ghcup > /dev/null 2>&1
          sudo rm -rf /opt/hostedtoolcache/CodeQL > /dev/null 2>&1
          sudo rm -rf /usr/share/swift > /dev/null 2>&1

          echo "================================="
          echo "-----> ç£ç›˜æ¸…ç†å <-----"
          df -h
          echo "================================="

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: é…ç½® SSH key
        # https://stackoverflow.com/questions/75578151/how-do-i-clone-a-repo-in-b-repo-github-actions-if-two-repo-is-in-same-organizati
        # NOTICE: ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ github actions é‡Œæ‹‰å–ï¼Œä¸è¿‡è¦ç”¨ https åè®®ï¼Œè€Œä¸”æäº¤çš„æ—¶å€™éœ€è¦è¿›è¡Œè´¦å¯†è®¤è¯
        # è€Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è¿™ä¸éœ€è¦è´¦å¯†è®¤è¯
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          name: id_rsa
          known_hosts: "github.com" # ${{ secrets.KNOWN_HOSTS }}
          if_key_exists: fail # replace / ignore / fail; optional (defaults to fail)

      - name: é…ç½® git è´¦å·
        run: |
          git config --global user.name "actions-user"
          git config --global user.email "actions-user@github.com"
          git config --global --list

      - name: è®¾ç½®è¿è¡Œç¯å¢ƒé…ç½®
        continue-on-error: true
        run: |
          git clone git@github.com:M-Kepler/dotfiles ~/dotfiles
          cd ~/dotfiles
          bash run.sh
          if [ "${{ inputs.SETUP_KIND }}" = "true" ]; then
            echo "ENABLE_K8S_TOOL=true" >> ~/.bashrc
            echo "ENABLE_K8S_TOOL=true" >> ~/.zshrc
          fi

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.PYTHON_VERSION }}

      - name: ç¼“å­˜ pip ä¾èµ–
        # [å…³äº setup-python ç¼“å­˜æ—¶æ²¡æœ‰æŠŠäºŒè¿›åˆ¶ä¸€èµ·ç¼“å­˜ä¸‹æ¥çš„é—®é¢˜](https://github.com/actions/setup-python/issues/330)
        continue-on-error: true
        uses: actions/cache@v4.2.2
        id: cache
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('mypy/requirements.txt') }}

      - name: ç¼“å­˜ apt åŒ…
        if: ${{ runner.os == 'Linux' }}
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: ${{ env.DEPENDENT_BINARY }} # è¦å®‰è£…çš„è½¯ä»¶åŒ…çš„ç©ºæ ¼åˆ†éš”åˆ—è¡¨
          version: 1.0 # è¦åŠ è½½çš„ç¼“å­˜ç‰ˆæœ¬

      - name: å®‰è£…ä¾èµ–ç¨‹åº
        continue-on-error: true
        uses: ConorMacBride/install-package@v1.1.0
        with:
          apt: ${{ env.DEPENDENT_BINARY }}
          choco: ${{ env.DEPENDENT_BINARY }}

      - name: æ‹‰å– Python ä»£ç  # ä¼šæŠŠä»£ç å…‹éš†åˆ° $GITHUB_WORKSPACE ä¸‹
        uses: actions/checkout@v4
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: å®‰è£…å­—ä½“
        if: ${{ runner.os == 'Linux' }}
        run: |
          bash mypy/mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}
        # windows ç‰ˆæ”¯æŒç”¨ gitbash æ‰§è¡Œå‘½ä»¤
        shell: bash

      # åœ¨æµæ°´çº¿æ‰§è¡Œè„šæœ¬åˆ›å»ºçš„æ–‡ä»¶å¤¹éƒ½æ˜¯ root æƒé™ï¼Œè€Œé€šè¿‡ action-debug è¿›å…¥ç¯å¢ƒæ—¶ docker:runner æƒé™
      # ä¼šå¯¼è‡´æ— æ³•æ“ä½œè¿™äº›æ–‡ä»¶æˆ–ç›®å½•, æ‰€ä»¥è¿˜æ˜¯è¿›å…¥ ssh åå†æ‰‹åŠ¨å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡å§
      # - name: å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡
      #   if: ${{ runner.os == 'Linux' }}
      #   continue-on-error: true
      #   run: |
      #     bash mypy/mypy/3party/init.sh

      - name: åˆ›å»ºè½¯é“¾
        continue-on-error: true
        run: |
          ln -s $GITHUB_WORKSPACE ~/workspace

          # åˆå§‹åŒ– mypy ç¯å¢ƒ
          echo "echo 'python-mypy init' && cd $GITHUB_WORKSPACE/mypy && bash env_init.sh" > ~/mypy-init.sh

      ##################################################
      # å®‰è£…é…ç½® kind é›†ç¾¤
      ##################################################
      - name: æ‹‰å– docker-compose
        if: ${{ inputs.SETUP_KIND }}
        run: |
          git clone git@github.com:M-Kepler/docker-compose
          ls -al ./docker-compose/

      - name: åˆ›å»º k8s kind é›†ç¾¤
        if: ${{ inputs.SETUP_KIND && runner.os == 'Linux' }}
        continue-on-error: true
        uses: helm/kind-action@v1.12.0
        with:
          # æ³¨æ„: å³ä½¿æŠŠ docker-compose clone åˆ° ~ ä¸‹ä¹Ÿæ— æ³•è®¿é—®åˆ°
          # é™¤éï¼Œä½ å…ˆ clone åˆ° $HOME ä¸‹ï¼Œç„¶åå†è¿›å…¥ç»ˆç«¯æ‰‹åŠ¨å¯åŠ¨
          config: ./docker-compose/00.kind/kind-3nodes.yaml
          cluster_name: test

      ##################################################
      # å†…ç½‘ç©¿é€
      ##################################################
      # - uses: fawazahmed0/action-debug@main
      - name: åˆ›å»ºé€€å‡º ssh è„šæœ¬
        run: |
          # ä¸€é”®é€€å‡º
          echo "touch $GITHUB_WORKSPACE/continue && echo 'å³å°†é€€å‡º github action æœåŠ¡å™¨'" > ~/quit-ssh
          chmod a+x ~/quit-ssh

      - uses: wordsworth-mk/action-debug@main
        continue-on-error: true # å³ä½¿å¤±è´¥äº†ä¹Ÿç»§ç»­åç»­æµç¨‹
        with:
          credentials: "1:1"
          loop_wait: ${{ inputs.SSH_WITH_VSCODE }} # æ˜¯å¦åœ¨è¿™é‡Œæ­»å¾ªç¯ç­‰å¾…é€€å‡º

      - name: é€šè¿‡ vscode è¿æ¥åˆ° github action
        if: ${{ inputs.SSH_WITH_VSCODE == 'false' }}
        uses: wordsworth-mk/action-debug-vscode@main
