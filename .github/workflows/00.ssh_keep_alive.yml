# https://zhuanlan.zhihu.com/p/387389708?utm_id=0
# https://github.com/marketplace/actions/debugging-with-tmate
# https://github.com/marketplace/actions/debugging-with-ssh

name: 00. ğŸ‰ ssh_keep_alive

on:
  workflow_dispatch:
    inputs:
      SYSTEM:
        type: choice
        description: "ç³»ç»Ÿ"
        required: false
        default: ubuntu-latest
        options:
          - windows-latest
          - ubuntu-latest

      FREE_DISK:
        type: boolean
        description: "é‡Šæ”¾ç£ç›˜ç©ºé—´"
        required: false
        default: false

  # # å®šæ—¶æ‰§è¡Œ
  # schedule:
  #   # ä»£è¡¨å›½é™…æ ‡å‡†æ—¶é—´ï¼Œå®é™…åŒ—äº¬æ—¶é—´éœ€è¦ +8 å°æ—¶
  #   - cron: "30 01 * * *"
  #   - cron: "30 07 * * *"

  # è¯¥äº‹ä»¶å¯ä»¥é€šè¿‡ API è§¦å‘
  repository_dispatch:
    types:
      - ssh_keep_alive

env:
  FONT_DIR: mypy/assets/font
  ENV_INIT_SCRIPT: mypy/env_init.sh
  DEPENDENT_BINARY: "ffmpeg libreoffice poppler-utils"
  PYTHON_VERSION: 3.9

jobs:
  new_ssh_keep_connect:
    # NOTICE: æ³¨æ„è¿™é‡Œè¦ç”¨å•å¼•å·
    runs-on: ${{ inputs.SYSTEM || 'ubuntu-latest' }}
    steps:
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        # runner.os == 'Linux' / 'Windows' è¦ç”¨å•å¼•å·
        if: ${{ inputs.FREE_DISK && runner.os == 'Linux' }}
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: æ¸…ç†ç£ç›˜
        if: ${{ inputs.FREE_DISK && runner.os == 'Linux' }}
        continue-on-error: true # å³ä½¿å¤±è´¥äº†ä¹Ÿç»§ç»­åç»­æµç¨‹
        run: |
          echo "================================="
          echo "-----> ç£ç›˜æ¸…ç†å‰ <-----"
          df -h
          echo "================================="

          docker rmi `docker images -q` > /dev/null 2>&1 || true
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php > /dev/null 2>&1
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* > /dev/null 2>&1 || true
          sudo -E apt-get -qq update > /dev/null 2>&1
          sudo -E apt-get -qq autoremove --purge > /dev/null 2>&1
          sudo -E apt-get -qq clean > /dev/null 2>&1

          # sudo find /opt/hostedtoolcache/* -maxdepth 1 -type d ! -name "Python" -exec rm -rf {} \; > /dev/null 2>&1
          # sudo -rf /usr/local/.ghcup > /dev/null 2>&1
          sudo rm -rf /opt/hostedtoolcache/CodeQL > /dev/null 2>&1
          sudo rm -rf /usr/share/swift > /dev/null 2>&1

          echo "================================="
          echo "-----> ç£ç›˜æ¸…ç†å <-----"
          df -h
          echo "================================="

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          name: id_rsa
          known_hosts: "github.com" # ${{ secrets.KNOWN_HOSTS }}
          if_key_exists: fail # replace / ignore / fail; optional (defaults to fail)

      - name: é…ç½® git è´¦å·
        run: |
          git config --global user.name "actions-user"
          git config --global user.email "actions-user@github.com"
          git config --global --list

      - name: è®¾ç½®è¿è¡Œç¯å¢ƒé…ç½®
        continue-on-error: true
        run: |
          git clone git@github.com:M-Kepler/dotfiles ~/dotfiles
          # pip æ¢äº†æºåè€Œæ›´æ…¢äº†
          # cd ~/dotfiles
          # export MSYSTEM=1
          # bash run.sh
          # sed -i '1i export MSYSTEM=1' ~/.bashrc

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…ä¾èµ–ç¨‹åº
        continue-on-error: true
        uses: ConorMacBride/install-package@v1.1.0
        with:
          apt: ${{ env.DEPENDENT_BINARY }}
          choco: ${{ env.DEPENDENT_BINARY }}

      - name: æ‹‰å– M-Kepler/Python
        uses: actions/checkout@v4
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: å®‰è£…å­—ä½“
        if: ${{ runner.os == 'Linux' }}
        run: |
          bash mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}
        # windows ç‰ˆæ”¯æŒç”¨ gitbash æ‰§è¡Œå‘½ä»¤
        shell: bash

      # åœ¨æµæ°´çº¿æ‰§è¡Œè„šæœ¬åˆ›å»ºçš„æ–‡ä»¶å¤¹éƒ½æ˜¯ root æƒé™ï¼Œè€Œé€šè¿‡ action-debug è¿›å…¥ç¯å¢ƒæ—¶ docker:runner æƒé™
      # ä¼šå¯¼è‡´æ— æ³•æ“ä½œè¿™äº›æ–‡ä»¶æˆ–ç›®å½•
      - name: å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡
        if: ${{ runner.os == 'Linux' }}
        continue-on-error: true
        run: |
          bash mypy/3party/init.sh

      - name: åˆ›å»ºè½¯é“¾
        continue-on-error: true
        run: |
          ln -s $GITHUB_WORKSPACE ~/my

          # åˆ›å»ºä¸ªè„šæœ¬ï¼Œç»§ç»­æ‰§è¡Œåç»­æµæ°´çº¿
          echo "touch $GITHUB_WORKSPACE/continue" > ~/quit_ssh
          chmod a+x ~/quit_ssh

      ##################################################
      # https://stackoverflow.com/questions/75578151/how-do-i-clone-a-repo-in-b-repo-github-actions-if-two-repo-is-in-same-organizati
      # NOTICE: ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ github actions é‡Œæ‹‰å–ï¼Œä¸è¿‡è¦ç”¨ https åè®®ï¼Œè€Œä¸”æäº¤çš„æ—¶å€™éœ€è¦è¿›è¡Œè´¦å¯†è®¤è¯
      # è€Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è¿™ä¸éœ€è¦è´¦å¯†è®¤è¯

      # - uses: fawazahmed0/action-debug@main
      - uses: wordsworth-mk/action-debug@main
        with:
          credentials: "user:password"
