name: 22. ðŸ“¦ æ‰“åŒ…å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      DO_RELEASE:
        description: "æ˜¯å¦åˆ›å»ºæ ‡ç­¾åŠå‘è¡Œç‰ˆ"
        type: boolean
        required: false
        default: false

      APP_DIR:
        description: "æ‰“åŒ…çš„ app åç§°"
        type: choice
        required: false
        default: "apps/baidu2douyin"
        options:
          - "all"
          - "apps/baidu2douyin"
          - "apps/test_app"
          - "tools/get_cookies.py"
          - "tools/launch_browser.py"

  workflow_call:
    inputs:
      DO_RELEASE:
        description: "æ˜¯å¦åˆ›å»ºæ ‡ç­¾åŠå‘è¡Œç‰ˆ"
        type: boolean
        required: false
        default: false

    secrets:
      MYPY_ACCESS_TOKEN:
        required: false

env:
  PYTHON_VERSION: 3.9
  APP_BASE_PATH: mypy/mypy/apps
  BUILD_TOOL: mypy/mypy/build/build.sh
  ENV_INIT_SCRIPT: mypy/env_init.sh
  # æ‰“åŒ…åŽçš„ APP å¯æ‰§è¡Œæ–‡ä»¶çš„å­˜æ”¾è·¯å¾„
  PKG_ZIP_PATH: mypy/mypy/build/_pkg.zip
  BUILD_PKG_PATH: mypy/mypy/build/_pkg/
  CHANGEL_LOG_PATH: mypy/mypy/CHANGELOG.md

jobs:
  package:
    name: æ‰“åŒ…
    runs-on: windows-latest

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }} çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v4.2.2
        id: cache
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('mypy/requirements.txt') }}

      # - name: å®‰è£…ä¾èµ–ç¨‹åº
      #   continue-on-error: true
      #   uses: ConorMacBride/install-package@v1.1.0
      #   with:
      #     apt: ${{ inputs.DEPENDENT_BINARY }}
      #     choco: ${{ inputs.DEPENDENT_BINARY }}

      # - name: å®‰è£…å­—ä½“
      #   run: |
      #     bash mypy/mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡ŒçŽ¯å¢ƒ
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        # windows ç‰ˆæ”¯æŒç”¨ gitbash æ‰§è¡Œå‘½ä»¤
        shell: bash

      - name: æ‰“åŒ…
        run: |
          # æŒ‡å®šåº”ç”¨æ‰“åŒ…
          # all è¡¨ç¤ºå…¨éƒ¨è¿›è¡Œæ‰“åŒ…
          if [[ -n "${{ inputs.APP_DIR }}" && "${{inputs.APP_DIR}}" != "all" ]]; then
            bash ${{ env.BUILD_TOOL }} mypy/mypy/${{ inputs.APP_DIR }}
          else
            for app in $(ls -d ${{ env.APP_BASE_PATH }}/*/); do
              bash ${{ env.BUILD_TOOL }} $app
            done
          fi

        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        shell: bash

      - name: åŽ‹ç¼©æ‰“åŒ…äº§ç‰©
        uses: vimtor/action-zip@v1.2
        with:
          files: ${{ env.BUILD_PKG_PATH }}
          dest: ${{ env.PKG_ZIP_PATH }}

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: èŽ·å–å½“å‰æ—¥æœŸ
        id: date
        run: |
          echo $(date +'%Y%m%d-%H%M%S')
          echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        shell: bash

      # è¿™ä¸ªç‰ˆæœ¬ä¸æ”¯æŒç»™å¤–éƒ¨ä»“åº“åˆ›å»ºå‘è¡Œç‰ˆ
      # - name: ä¸Šä¼  Release
      #   id: upload-release-asset
      #   if: ${{ inputs.DO_RELEASE }}
      #   uses: actions/upload-release-asset@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ${{ github.workspace }}/${{ env.PKG_ZIP_PATH }}
      #     asset_name: pkg.zip
      #     asset_content_type: application/zip

      # https://github.com/softprops/action-gh-release
      - name: åˆ›å»º Github å‘è¡Œç‰ˆ
        id: create_release
        if: ${{ inputs.DO_RELEASE }}
        uses: softprops/action-gh-release@v2.0.6
        env:
          GITHUB_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}-${{ steps.date.outputs.date }}
          name: release-${{ github.ref_name }}-${{ steps.date.outputs.date }}
          body_path: ${{ env.CHANGEL_LOG_PATH }}
          files: |
            ${{ github.workspace }}/${{ env.PKG_ZIP_PATH }}
          draft: false
          prerelease: false
          repository: M-Kepler/Python

      # å½“ä½ ä¸Šä¼ æˆåŠŸåŽï¼ŒåŽç»­çš„æµç¨‹å°±å¯ä»¥ä¸‹è½½è¿™äº›æ–‡ä»¶æ¥ä½¿ç”¨ï¼ˆå¯ä»¥åœ¨æµæ°´çº¿ä¸‹è½½ï¼‰
      # Github actions Artifact å¯ä»¥ç”¨æ¥å­˜å‚¨ action äº§ç‰©
      - name: ä¸Šä¼  Artifact
        if: ${{ ! inputs.DO_RELEASE }}
        uses: actions/upload-artifact@master
        with:
          name: ${{ steps.date.outputs.date }}-Build
          # compression-level: 9 # maximum compression
          path: |
            ${{ env.PKG_ZIP_PATH }}

  update_changelog:
    name: æ›´æ–° CHANGELOG.md
    runs-on: ubuntu-latest
    if: ${{ inputs.DO_RELEASE }}
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: èŽ·å–å½“å‰æ—¥æœŸ
        id: date
        run: |
          echo $(date +'%Y%m%d-%H%M%S')
          echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: æ›´æ–° CHANGELLOG
        continue-on-error: true
        if: ${{ inputs.DO_RELEASE }}
        uses: saadmk11/changelog-ci@v1.1.2
        with:
          release_version: ${{ github.ref_name }}-${{ steps.date.outputs.date }}
          github_token: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: èŽ·å– Changelog è¾“å‡º
        continue-on-error: true
        run: |
          echo "${{ steps.changelog-ci.outputs.changelog }}"
          # $GITHUB_STEP_SUMMARY åªæœ‰ç­‰è¿™ä¸ª job æ‰§è¡Œå®Œäº†æ‰ä¼šè¾“å‡ºå‡ºæ¥
          echo "${{ steps.changelog-ci.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
