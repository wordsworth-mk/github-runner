name: ğŸ“¦ æ‰“åŒ…å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: "æ˜¯å¦åˆ›å»ºæ ‡ç­¾åŠå‘è¡Œç‰ˆ"
        type: boolean
        required: false
        default: false

  workflow_call:
    inputs:
      APPS_PATH:
        description: "éœ€è¦æ‰“åŒ…çš„ APP è·¯å¾„åˆ—è¡¨"
        required: true
        type: string
    # å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™æä¾› token ç”¨æ¥æ‹‰å–æœ¬ç§æœ‰ä»“åº“
    secrets:
      MYPY_ACCESS_TOKEN:
        required: false

env:
  ENV_INIT_SCRIPT: mypy/env_init.sh

  # æ‰“åŒ…åçš„ APP å¯æ‰§è¡Œæ–‡ä»¶çš„å­˜æ”¾è·¯å¾„
  PKG_ZIP_PATH: mypy/build/_pkg.zip
  BUILD_PKG_PATH: mypy/build/_pkg/

jobs:
  build:
    strategy:
      matrix:
        # DEBUG
        python-version: ["3.9"]
        # os: [ubuntu-latest]
        os: [windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: è®¾ç½® Python ${{ matrix.python-version }} ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # - name: å®‰è£…ä¾èµ–ç¨‹åº
      #   uses: ConorMacBride/install-package@v1.1.0
      #   with:
      #     apt: ${{ inputs.DEPENDENT_BINARY }}
      #     choco: ${{ inputs.DEPENDENT_BINARY }}

      # - name: å®‰è£…å­—ä½“
      #   run: |
      #     bash mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        # windows ç‰ˆæ”¯æŒç”¨ gitbash æ‰§è¡Œå‘½ä»¤
        shell: bash

      - uses: syphar/restore-virtualenv@v1
        id: cache-virtualenv
        with:
          requirement_files: mypy/requirements.txt  # this is optional

      - uses: syphar/restore-pip-download-cache@v1
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'

        # the package installation will only be executed when the
        # requirements-files have changed.
      - run: pip install -r mypy/requirements.txt
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'

      - name: æ‰“åŒ…
        run: |
          # type1: ä¼ å…¥çš„æ˜¯å•ä¸ª APP è·¯å¾„
          # bash mypy/build/build.sh ${{ inputs.APP_PATH }}

          # type2: ä¼ å…¥çš„æ˜¯ APP çˆ¶ç›®å½•
          # echo ${{ inputs.APPS_PATH }}
          # for app in $(ls ${{ inputs.APPS_PATH }}); do
          #     if [ ! -f mypy/apps/$app/main.py ]; then
          #         continue
          #     fi
          #     bash mypy/build/build.sh mypy/apps/$app
          # done
          # artifat_path=$curr_path/_pkg.zip
          # zip -r $artifat_path $curr_path/_pkg/
          # echo "================================================"
          # echo "æ‰“åŒ…å®Œæˆ: $artifat_path"
          # echo "================================================"

          # type3: æ‰§è¡Œå¤–éƒ¨è„šæœ¬è¿›è¡Œæ‰“åŒ…
          bash mypy/build/batch_build.sh
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        shell: bash

      - name: zip
        uses: vimtor/action-zip@v1.2
        with:
          files: ${{ env.BUILD_PKG_PATH }}
          dest: mypy/build/_pkg.zip

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: è·å–å½“å‰æ—¥æœŸ
        id: date
        run: |
          echo $(date +'%Y%m%d-%H%M%S')
          echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

        shell: bash

      - name: æ›´æ–° CHANGELLOG
        id: update_changelog
        if: ${{ inputs.create_release }}
        uses: saadmk11/changelog-ci@v1.1.2

      - name: åˆ›å»º Tag
        id: create_release
        if: ${{ inputs.create_release }}
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}-${{ steps.date.outputs.date }}
          name: release-${{ github.ref_name }}-${{ steps.date.outputs.date }}
          draft: false
          prerelease: false

      - name: ä¸Šä¼  Release
        id: upload-release-asset
        if: ${{ inputs.create_release }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}/${{ env.PKG_ZIP_PATH }}
          asset_name: pkg.zip
          asset_content_type: application/zip

      # Github actions Artifact å¯ä»¥ç”¨æ¥å­˜å‚¨ action ç”Ÿäº§å‡ºæ¥çš„äº§ç‰©
      # å½“ä½ ä¸Šä¼ æˆåŠŸåï¼Œåç»­çš„æµç¨‹å°±å¯ä»¥ä¸‹è½½è¿™äº›æ–‡ä»¶æ¥ä½¿ç”¨
      - name: ä¸Šä¼  Artifact
        if: ${{ ! inputs.create_release }}
        uses: actions/upload-artifact@master
        with:
          name: ${{ matrix.os }} Build
          path: |
            ${{ env.PKG_ZIP_PATH }}
