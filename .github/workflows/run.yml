# å’Œ M-Kepler/Python/.github/workflows/run.yml@master ä¸€æ ·
name: ğŸšš è¿è¡Œåº”ç”¨

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      APP:
        description: "mypy/apps ä¸‹çš„åº”ç”¨åç§°"
        required: true
        type: string
        default: "test_app"
      ARGS:
        description: "åº”ç”¨å‚æ•°"
        type: string
        required: false
      DEPENDENT_BINARY:
        description: "ä¾èµ–çš„äºŒè¿›åˆ¶ç¨‹åº"
        type: string
        required: false
        default: "ffmpeg unoconv libreoffice poppler-utils"
      SIMPLE_RUN:
        description: "æ˜¯å¦ç®€å•è¿è¡Œï¼ˆä¸å®‰è£…ç¨‹åºä¾èµ–å’Œå­—ä½“ï¼‰"
        type: boolean
        required: false
        default: true

  # æµæ°´çº¿è°ƒç”¨
  workflow_call:
    inputs:
      APP:
        description: "mypy/apps ä¸‹çš„åº”ç”¨åç§°"
        required: true
        type: string
      ARGS:
        description: "åº”ç”¨å‚æ•°"
        type: string
        required: false
      SIMPLE_RUN:
        description: "æ˜¯å¦å®‰è£…ç¨‹åºä¾èµ–å’Œå­—ä½“"
        type: boolean
        required: false
        default: false
      DEPENDENT_BINARY:
        description: "ä¾èµ–çš„äºŒè¿›åˆ¶ç¨‹åº"
        type: string
        required: false
        default: "ffmpeg unoconv libreoffice poppler-utils"

    # å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™æä¾› token ç”¨æ¥æ‹‰å–æœ¬ç§æœ‰ä»“åº“
    secrets:
      MYPY_ACCESS_TOKEN:
        required: false

# env ä¸Šä¸‹æ–‡åªèƒ½åœ¨ run æ­¥éª¤ä¸­ä½¿ç”¨
env:
  APP_BASE_PATH: mypy/apps
  APP_ENTRY: main.py
  FONT_DIR: mypy/assets/font
  ENV_INIT_SCRIPT: mypy/env_init.sh
  TIME_ZONE: "Asia/Singapore"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        # uses ä¹‹åä¸èƒ½å†ç”¨ run
        uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v1.2
        with:
          timezoneLinux: ${{ env.TIME_ZONE }}
          timezoneMacos: ${{ env.TIME_ZONE }}
          timezoneWindows: ${{ env.TIME_ZONE }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: 3.8

      - name: å®‰è£…ä¾èµ–ç¨‹åº
        uses: ConorMacBride/install-package@v1.1.0
        if: ${{ ! inputs.SIMPLE_RUN }}
        with:
          apt: ${{ inputs.DEPENDENT_BINARY }}

      - name: å®‰è£…å­—ä½“
        if: ${{ ! inputs.SIMPLE_RUN }}
        run: |
          bash mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}

      - name: ğŸ”´ğŸŸ¡ğŸŸ¢ è¿è¡Œ ğŸŸ¢ğŸŸ¡ğŸ”´
        run: |
          cd ${{ env.APP_BASE_PATH }}/${{ inputs.APP }}
          if [ ! -z "${{ inputs.ARGS }}" ]; then
              python ${{ env.APP_ENTRY }} ${{ inputs.ARGS }}
          else
              python ${{ env.APP_ENTRY }}
          fi

      - name: ä¿å­˜è¿è¡Œè¿‡ç¨‹ä¿®æ”¹çš„é…ç½®
        if: ${{ success() }} # è¿™ä¸€æ­¥åªä¼šåœ¨å‰ä¸€æ­¥æˆåŠŸæ—¶æ‰§è¡Œ
        env:
          # è¿™ä¸ª token ä¸éœ€è¦é…ç½®ï¼Œé»˜è®¤è‡ªå¸¦çš„
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github_action"
          git status
          git pull
          # ä¸ºäº†è®© `**` åœ¨Gitå‘½ä»¤ä¸­é€’å½’åœ°å·¥ä½œï¼Œéœ€è¦åœ¨ä½ çš„Gité…ç½®ä¸­è®¾ç½® core.globstar ä¸ºtrue
          git config --global core.globstar true
          # æ·»åŠ æ‰€æœ‰çš„é…ç½®æ–‡ä»¶æ”¹åŠ¨
          git add **/*.ini
          git add **/*.json
          # æ— æ”¹åŠ¨ä¸æŠ¥é”™
          git diff --cached --exit-code || git commit -m "[UPD][${{ inputs.APP }}]: commit githubaction change"
          git push origin master
