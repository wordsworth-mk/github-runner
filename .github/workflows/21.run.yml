##########################################
# ä¹Ÿå¯ä»¥ç›´æ¥ç”¨è¿™ä¸ªæµæ°´çº¿è¿è¡Œ app
##########################################

# è¿™ä¸ªåç§°ä¼šå±•ç¤ºåœ¨ github action ä¸Š
# æ–‡ä»¶åç”±äºè¢«å…¶ä»–æµæ°´çº¿å¼•ç”¨ï¼Œæ‰€ä»¥ä¸è¦è½»æ˜“æ”¹åŠ¨
name: 21. ğŸšš è¿è¡Œåº”ç”¨

on:
  # æ‰‹åŠ¨è§¦å‘
  # [æ”¯æŒçš„å˜é‡ç±»å‹](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_dispatchinputsinput_idtype)
  # workflow_dispatch æ‰æ”¯æŒ environment ç±»å‹çš„å˜é‡
  workflow_dispatch:
    inputs:
      ENV_PUBLISH_PLATFORMS:
        type: string
        description: "é€‰æ‹©å‘å¸ƒå¹³å°ï¼Œç”¨ ',' åˆ†å‰²ï¼ˆä¸å¸¦ç©ºæ ¼ï¼Œå¯é€‰é¡¹: douyin,weixin,xiaohongshuï¼‰"
        required: false
        default: "douyin"

      APP:
        description: "mypy/apps ä¸‹çš„åº”ç”¨åç§°"
        required: true
        type: string
        default: "test_app"

      ARGS:
        description: "åº”ç”¨å‚æ•°"
        type: string
        required: false

      DEPENDENT_BINARY:
        description: "ä¾èµ–çš„äºŒè¿›åˆ¶ç¨‹åº"
        type: string
        required: false
        default: "ffmpeg libreoffice poppler-utils wkhtmltopdf"

      SIMPLE_RUN:
        description: "æ˜¯å¦ç®€å•è¿è¡Œï¼ˆä¸å®‰è£…ç¨‹åºä¾èµ–å’Œå­—ä½“ï¼Œä¹Ÿä¸å®‰è£… mypyï¼‰"
        type: boolean
        required: false
        default: false

      COMMIT_CHANGE:
        description: "æ˜¯å¦æäº¤æ›´æ”¹"
        type: boolean
        required: false
        default: true

      WITH_3PARTY:
        description: "æ˜¯å¦å®‰è£… 3party ä¸‹çš„æœåŠ¡"
        type: boolean
        required: false
        default: false

      DEBUG:
        description: "æ”¯æŒè¿æ¥åˆ°è™šæ‹Ÿæœºè¿›è¡Œè°ƒè¯•"
        type: boolean
        required: false
        default: false

      REF:
        description: "Python ä»“åº“åˆ†æ”¯æˆ–æ ‡ç­¾ã€æäº¤ID"
        type: string
        required: false
        default: master

  # æµæ°´çº¿è°ƒç”¨
  # [æ”¯æŒçš„å˜é‡ç±»å‹](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callinputsinput_idtype)
  workflow_call:
    inputs:
      APP:
        description: "mypy/apps ä¸‹çš„åº”ç”¨åç§°"
        required: true
        type: string

      ENV_BAIDU_AIGC_TYPE:
        type: string
        description: "AI ç”Ÿæˆå†…å®¹ç±»å‹"
        required: false
        default: "PPT"

      ENV_BAIDU_AIGC_TOPIC:
        type: string
        description: "å‘å¸ƒå†…å®¹çš„ä¸»é¢˜"
        required: false
        default: ""

      ENV_PUBLISH_MEDIA_TYPE:
        type: string
        # å®šä¹‰åœ¨ const.py/MEDIA_TYPE_IMG_ARTICLE
        description: "å‘å¸ƒåª’ä½“ç±»å‹"
        required: false
        default: "video"

      # è®¾ç½®åˆ°ç¯å¢ƒå˜é‡
      ENV_PUBLISH_PLATFORMS:
        type: string
        description: "é€‰æ‹©å‘å¸ƒå¹³å°ï¼Œç”¨ ',' åˆ†å‰²ï¼ˆä¸å¸¦ç©ºæ ¼ï¼Œå¯é€‰é¡¹: douyin,weixin,xiaohongshuï¼‰"
        required: false
        default: "douyin"

      ENV_PUBLISH_MOD:
        type: string
        description: "é€‰æ‹©å‘å¸ƒæ—¶é—´æ¨¡å¼"
        required: false
        default: "timing"

      ENV_PUBLISH_ACCOUNT:
        type: string
        description: "é€‰æ‹©è´¦å·ï¼ˆå¯é€‰: large å¤§å·, middle ä¸­å·, test æµ‹è¯•è´¦å·ï¼‰"
        required: false
        default: "large"

      ARGS:
        description: "åº”ç”¨å‚æ•°"
        type: string
        required: false

      SIMPLE_RUN:
        description: "æ˜¯å¦ç®€å•è¿è¡Œï¼ˆä¸å®‰è£…ç¨‹åºä¾èµ–å’Œå­—ä½“ï¼Œä¹Ÿä¸å®‰è£… mypyï¼‰"
        type: boolean
        required: false
        default: false

      DEPENDENT_BINARY:
        description: "ä¾èµ–çš„äºŒè¿›åˆ¶ç¨‹åº"
        type: string
        required: false
        default: "ffmpeg libreoffice poppler-utils wkhtmltopdf"

      FORCE_COMMIT:
        description: "ä¸ç®¡æ˜¯å¦è¿è¡ŒæˆåŠŸï¼Œéƒ½æäº¤æ”¹åŠ¨çš„ä¿¡æ¯"
        type: boolean
        required: false
        default: false

      COMMIT_CHANGE:
        description: "æ˜¯å¦æäº¤æ›´æ”¹"
        type: boolean
        required: false
        default: true

      WITH_3PARTY:
        description: "æ˜¯å¦å®‰è£… 3party ä¸‹çš„æœåŠ¡"
        type: boolean
        required: false
        default: true

      DEBUG:
        description: "æ”¯æŒè¿æ¥åˆ°è™šæ‹Ÿæœºè¿›è¡Œè°ƒè¯•"
        type: boolean
        required: false
        default: false

      REF:
        description: "Python ä»“åº“åˆ†æ”¯æˆ–æ ‡ç­¾ã€æäº¤ID"
        type: string
        required: false
        default: master

    # å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™æä¾› token ç”¨æ¥æ‹‰å–æœ¬ç§æœ‰ä»“åº“
    secrets:
      MYPY_ACCESS_TOKEN:
        required: false

# env ä¸Šä¸‹æ–‡åªèƒ½åœ¨ run æ­¥éª¤ä¸­ä½¿ç”¨
env:
  APP_BASE_PATH: mypy/mypy/apps
  APP_ENTRY: main.py
  FONT_DIR: mypy/mypy/assets/font
  # ç¯å¢ƒå˜é‡
  ENV_INIT_SCRIPT: mypy/env_init.sh
  ENV_IN_GITHUBACTION: true
  ENV_PUBLISH_MOD: ${{ github.event.inputs.ENV_PUBLISH_MOD }}
  ENV_PUBLISH_PLATFORMS: ${{ github.event.inputs.ENV_PUBLISH_PLATFORMS }}
  ENV_PUBLISH_ACCOUNT: ${{ github.event.inputs.ENV_PUBLISH_ACCOUNT }}
  ENV_PUBLISH_MEDIA_TYPE: ${{ github.event.inputs.ENV_PUBLISH_MEDIA_TYPE }}
  ENV_BAIDU_AIGC_TYPE: ${{ github.event.inputs.ENV_BAIDU_AIGC_TYPE }}
  ENV_BAIDU_AIGC_TOPIC: ${{ github.event.inputs.ENV_BAIDU_AIGC_TOPIC }}

jobs:
  run:
    name: ğŸ”´ğŸŸ¡ğŸŸ¢ è¿è¡Œ ğŸŸ¢ğŸŸ¡ğŸ”´
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # uses ä¹‹åä¸èƒ½å†ç”¨ run
        uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python
          ref: ${{ inputs.REF || 'master' }}

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      # [å…³äº setup-python ç¼“å­˜æ—¶æ²¡æœ‰æŠŠäºŒè¿›åˆ¶ä¸€èµ·ç¼“å­˜ä¸‹æ¥çš„é—®é¢˜](https://github.com/actions/setup-python/issues/330)
      - name: ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v4.2.2
        id: cache
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('mypy/requirements.txt') }}

      - name: ç¼“å­˜ apt åŒ…
        if: ${{ ! inputs.SIMPLE_RUN }}
        continue-on-error: true
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: ${{ inputs.DEPENDENT_BINARY }} # è¦å®‰è£…çš„è½¯ä»¶åŒ…çš„ç©ºæ ¼åˆ†éš”åˆ—è¡¨
          version: 1.0 # è¦åŠ è½½çš„ç¼“å­˜ç‰ˆæœ¬

      - name: å®‰è£…ä¾èµ–ç¨‹åº
        uses: ConorMacBride/install-package@v1.1.0
        if: ${{ ! inputs.SIMPLE_RUN && steps.cache.outputs.cache-hit != 'true' }}
        with:
          apt: ${{ inputs.DEPENDENT_BINARY }}
          choco: ${{ inputs.DEPENDENT_BINARY }}

      - name: å®‰è£…å­—ä½“
        if: ${{ ! inputs.SIMPLE_RUN }}
        run: |
          bash mypy/mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        if: ${{ ! inputs.SIMPLE_RUN }}
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}

      - name: å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡
        if: ${{ inputs.WITH_3PARTY && ! inputs.SIMPLE_RUN }}
        continue-on-error: true
        run: |
          bash mypy/mypy/3party/init.sh

      - name: è°ƒè¯•
        if: ${{ inputs.DEBUG }}
        uses: wordsworth-mk/action-debug@main
        with:
          credentials: "user:password"

      - name: ğŸ”´ğŸŸ¡ğŸŸ¢ è¿è¡Œ ğŸŸ¢ğŸŸ¡ğŸ”´
        run: |
          cd ${{ env.APP_BASE_PATH }}/${{ inputs.APP }}
          python ${{ env.APP_ENTRY }} ${{ inputs.ARGS }}

      - name: ä¿å­˜è¿è¡Œè¿‡ç¨‹ä¿®æ”¹çš„é…ç½®
        if: ${{ (success() && inputs.COMMIT_CHANGE) || inputs.FORCE_COMMIT }} # è¿™ä¸€æ­¥åªä¼šåœ¨å‰ä¸€æ­¥æˆåŠŸæ—¶æ‰§è¡Œ
        env:
          # è¿™ä¸ª token ä¸éœ€è¦é…ç½®ï¼Œé»˜è®¤è‡ªå¸¦çš„
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "===== git é…ç½® ====="
          git config --global user.email "actions@github.com"
          git config --global user.name "github_action"
          git config --global pull.rebase true
          # ä¸ºäº†è®© `**` åœ¨Gitå‘½ä»¤ä¸­é€’å½’åœ°å·¥ä½œ, éœ€è¦åœ¨ä½ çš„Gité…ç½®ä¸­è®¾ç½® core.globstar ä¸º true
          git config --global core.globstar true

          git pull
          echo "===== æäº¤æ”¹åŠ¨ ====="
          git status
          # # æ·»åŠ æ‰€æœ‰çš„é…ç½®æ–‡ä»¶æ”¹åŠ¨
          # git add **/*.ini
          # git add **/*.json
          git add .
          # æ— æ”¹åŠ¨ä¸æŠ¥é”™
          git diff --cached --exit-code || git commit -m "[UPD][${{ inputs.APP }}]: commit githubaction change"
          git push origin master
