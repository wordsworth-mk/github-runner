# https://zhuanlan.zhihu.com/p/387389708?utm_id=0
# https://github.com/marketplace/actions/debugging-with-tmate
# https://github.com/marketplace/actions/debugging-with-ssh

name: ğŸ‰ ssh_keep_connect

on:
  workflow_dispatch:
    inputs:
      SIMPLE_RUN:
        type: boolean
        description: "å•çº¯èµ·ä¸ª SSH"
        required: false
        default: false

env:
  FONT_DIR: mypy/assets/font
  ENV_INIT_SCRIPT: mypy/env_init.sh
  DEPENDENT_BINARY: "ffmpeg unoconv libreoffice poppler-utils"
  PYTHON_VERSION: 3.9

jobs:
  new_ssh_keep_connect:
    runs-on: ubuntu-latest
    steps:
      - name: æ¸…ç†ç£ç›˜
        run: |
          echo "================================="
          echo "-----> ç£ç›˜æ¸…ç†å‰ <-----"
          df -h
          echo "================================="

          docker rmi `docker images -q` > /dev/null 2>&1
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php > /dev/null 2>&1
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* || true > /dev/null 2>&1
          sudo -E apt-get -qq update > /dev/null 2>&1
          sudo -E apt-get -qq install libfuse-dev $(curl -fsSL git.io/depends-ubuntu-2204) > /dev/null 2>&1
          sudo -E apt-get -qq autoremove --purge > /dev/null 2>&1
          sudo -E apt-get -qq clean > /dev/null 2>&1

          find /opt/hostedtoolcache/ -maxdepth 1 -type d ! -name "Python" -exec rm -rf {} + > /dev/null 2>&1
          sudo -rf /usr/local/.ghcup > /dev/null 2>&1
          sudo rm -rf /usr/share/swift > /dev/null 2>&1

          echo "================================="
          echo "-----> ç£ç›˜æ¸…ç†å <-----"
          df -h
          echo "================================="

      - name: Checkout
        if: ${{ ! inputs.SIMPLE_RUN }}
        uses: actions/checkout@v4
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          name: id_rsa
          known_hosts: "github.com" # ${{ secrets.KNOWN_HOSTS }}
          if_key_exists: fail # replace / ignore / fail; optional (defaults to fail)

      - name: é…ç½® git è´¦å·
        run: |
          git config --global user.name "actions-user"
          git config --global user.email "actions-user@github.com"
          git config --global --list

      - name: æ‹‰å–å…¶ä»–ä»“åº“
        run: |
          git clone git@github.com:M-Kepler/dotfiles ~/dotfiles

      - name: è®¾ç½®è¿è¡Œç¯å¢ƒé…ç½®
        run: |
          cd ~/dotfiles
          export MSYSTEM=1
          bash run.sh
          sed -i '1i export MSYSTEM=1' ~/.bashrc

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…ä¾èµ–ç¨‹åº
        if: ${{ ! inputs.SIMPLE_RUN }}
        uses: ConorMacBride/install-package@v1.1.0
        with:
          apt: ${{ env.DEPENDENT_BINARY }}

      - name: å®‰è£…å­—ä½“
        if: ${{ ! inputs.SIMPLE_RUN }}
        run: |
          bash mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        if: ${{ ! inputs.SIMPLE_RUN }}
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}

      - name: å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡
        if: ${{ ! inputs.SIMPLE_RUN }}
        continue-on-error: true # å³ä½¿å¤±è´¥äº†ä¹Ÿç»§ç»­åç»­æµç¨‹
        run: |
          bash mypy/3party/init.sh

      ##################################################
      # https://stackoverflow.com/questions/75578151/how-do-i-clone-a-repo-in-b-repo-github-actions-if-two-repo-is-in-same-organizati
      # NOTICE: ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ github actions é‡Œæ‹‰å–ï¼Œä¸è¿‡è¦ç”¨ https åè®®ï¼Œè€Œä¸”æäº¤çš„æ—¶å€™éœ€è¦è¿›è¡Œè´¦å¯†è®¤è¯
      # è€Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è¿™ä¸éœ€è¦è´¦å¯†è®¤è¯

      - name: è®¾ç½® Bash
        run: |
          cat << EOF >> ~/.bashrc
          set -o vi
          bind -m vi-insert '\c-l':clear-screen
          alias ..="cd .."
          alias ll='ls -l'
          alias la='ls -A'
          alias g='git'
          alias cls='clear'
          export PS1="\[\e[1;32m\]\u@\h\[\e[0m\]:\[\e[1;34m\]\w\[\e[0m\]\$ "
          EOF
          # è¿æ¥åå†æ‰§è¡Œæ‰æœ‰ç”¨
          source ~/.bashrc

      - uses: fawazahmed0/action-debug@main
        with:
          credentials: "user:password"
