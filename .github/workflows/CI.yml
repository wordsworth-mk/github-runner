name: ğŸ’¯ CI

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      SKIP_CASE_MARK:
        description: "éœ€è¦è·³è¿‡çš„ç”¨ä¾‹æ ‡ç­¾ ('none' è¡¨ç¤ºä¸è·³è¿‡)"
        required: false
        default: "none"
      UNITTEST:
        description: "æ˜¯å¦è¿›è¡Œå•å…ƒæµ‹è¯•"
        type: boolean
        required: false
        default: true

  schedule:
    # ä»£è¡¨å›½é™…æ ‡å‡†æ—¶é—´ 21 ç‚¹ 30 åˆ†ï¼ŒåŒ—äº¬æ—¶é—´éœ€è¦ +8 å°æ—¶ï¼Œä»£è¡¨åŒ—äº¬æ—¶é—´ä¸Šåˆ 5 ç‚¹ 30 åˆ†ç‚¹è¿è¡Œ
    - cron: "30 21 * * 5"

# NOTICE: env ä¸Šä¸‹æ–‡åªèƒ½åœ¨ run æ­¥éª¤ä¸­ä½¿ç”¨
env:
  BASE_PATH: mypy
  APP_BASE_PATH: mypy/apps

jobs:
  ###########################################
  # è¯­æ³•æ£€æŸ¥
  ###########################################
  syntax_check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    uses: wordsworth-mk/github-runner/.github/workflows/syntax_check.yml@main
    with:
      APP_PATH: mypy

  ###########################################
  # å•å…ƒæµ‹è¯• å’Œ ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
  ###########################################
  unittest:
    name: å•å…ƒæµ‹è¯•
    if: ${{ inputs.UNITTEST || true }}
    needs:
      - syntax_check

    uses: wordsworth-mk/github-runner/.github/workflows/unittest.yml@main
    # è¦åœ¨ with å­å¥ä¸­ä¼ é€’ç¯å¢ƒå˜é‡ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨ secrets æˆ– inputs
    with:
      CASE_PATH: mypy/tests
      # ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶
      DEPENDENT_BINARY: "ffmpeg unoconv libreoffice poppler-utils"
      NOT_RUN_MARK: ${{ inputs.SKIP_CASE_MARK }}
    secrets:
      ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}

  ###########################################
  # è·å–æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤¹å¹¶å°†å®ƒä»¬ä½œä¸ºå˜é‡ä½¿ç”¨
  # OK
  ###########################################
  get_apps:
    name: è·å–æ‰“åŒ… APP åç§°åˆ—è¡¨
    runs-on: ubuntu-latest
    # è®¾ç½®è¾“å‡ºï¼Œå¯åœ¨å¤šä¸ªä½œä¸šé—´ä¼ é€’å‚æ•°
    outputs:
      apps: ${{ steps.set-matrix.outputs.apps }}

    steps:
      - uses: actions/checkout@v4
      - name: è·å–æ‰“åŒ… APP è·¯å¾„åˆ—è¡¨
        id: set-matrix
        run: |
          apps=$(bash ${{ env.BASE_PATH }}/build/get_apps.sh ${{ env.APP_BASE_PATH }})
          echo "found apps: $apps"
          # key=value æ ¼å¼
          echo "apps=[$apps]" >> $GITHUB_OUTPUT
          echo "base_path=${{ env.BASE_PATH }}" >> $GITHUB_OUTPUT

  ###########################################
  # æ‰“åŒ…
  ###########################################
  # æ²¡å¿…è¦ä¸€ä¸ªä¸ªè®¾ç½®ç¯å¢ƒå†æ‰“åŒ…
  package:
    name: æ‰“åŒ…å‘å¸ƒ
    needs:
      - syntax_check
      - get_apps
      - unittest
    uses: wordsworth-mk/github-runner/.github/workflows/package.yml@main

    # ä½¿ç”¨å‰é¢çš„ job çš„è¾“å‡º
    # #### ä¸ç”¨ matrix å¤šä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªä»»åŠ¡è¿›è¡Œæ‰“åŒ…å°±å¯ä»¥äº†
    # strategy:
    #   matrix:
    #     apps: ${{ fromJSON(needs.get_apps.outputs.apps) }}

    with:
      # APPS_PATH: ${{ fromJSON(needs.get_apps.outputs.apps) }}
      APPS_PATH: mypy/apps
      PKG_ZIP_PATH: mypy/build/_pkg.zip
