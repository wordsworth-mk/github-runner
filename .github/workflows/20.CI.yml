name: 20. ğŸ’¯ CI

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      CASE_SKIP_MARK:
        description: "éœ€è¦è·³è¿‡çš„ç”¨ä¾‹æ ‡ç­¾ ('none' è¡¨ç¤ºä¸è·³è¿‡)"
        required: false
        default: "none"
      UNITTEST:
        description: "æ˜¯å¦è¿›è¡Œå•å…ƒæµ‹è¯•"
        type: boolean
        required: false
        default: true
      DO_RELEASE:
        description: "æ˜¯å¦è¿›è¡Œæ‰“åŒ…å¹¶åˆ›å»ºå‘è¡Œç‰ˆ"
        type: boolean
        required: false
        default: false

  schedule:
    # ä»£è¡¨åŒ—äº¬æ—¶é—´æ¯å‘¨äº” 17:30
    - cron: "30 09 * * 5"

# NOTICE: env ä¸Šä¸‹æ–‡åªèƒ½åœ¨ run æ­¥éª¤ä¸­ä½¿ç”¨
env:
  BASE_PATH: mypy/mypy

jobs:
  ###########################################
  # è¯­æ³•æ£€æŸ¥
  ###########################################
  syntax_check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    # è¿™ä¸ª uses ä¸èƒ½ç”¨ç¯å¢ƒå˜é‡
    uses: wordsworth-mk/github-runner/.github/workflows/24.syntax_check.yml@main
    with:
      BASE_PATH: mypy/mypy
    secrets:
      MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN }}

  ###########################################
  # å•å…ƒæµ‹è¯• å’Œ ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
  ###########################################
  unittest:
    name: å•å…ƒæµ‹è¯•
    if: ${{ inputs.UNITTEST || true }}
    needs:
      - syntax_check

    uses: wordsworth-mk/github-runner/.github/workflows/23.unittest.yml@main
    # NOTICE è¦åœ¨ with å­å¥ä¸­ä¼ é€’ç¯å¢ƒå˜é‡ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨ secrets æˆ– inputs
    with:
      CASE_PATH: mypy/mypy/tests
      # ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶
      DEPENDENT_BINARY: "ffmpeg libreoffice poppler-utils wkhtmltopdf"
      NOT_RUN_MARK: ${{ inputs.CASE_SKIP_MARK }}
    secrets:
      ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
      MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN }}

  ###########################################
  # è·å–æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤¹å¹¶å°†å®ƒä»¬ä½œä¸ºå˜é‡ä½¿ç”¨
  # OK
  ###########################################
  get_apps:
    name: è·å–æ‰“åŒ… APP åç§°åˆ—è¡¨
    runs-on: ubuntu-latest
    # è®¾ç½®è¾“å‡ºï¼Œå¯åœ¨å¤šä¸ªä½œä¸šé—´ä¼ é€’å‚æ•°
    outputs:
      apps: ${{ steps.set-matrix.outputs.apps }}

    steps:
      - uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: è·å–æ‰“åŒ… APP è·¯å¾„åˆ—è¡¨
        id: set-matrix
        run: |
          apps=$(bash ${{ env.BASE_PATH }}/build/get_apps.sh "mypy/mypy/apps")
          echo "found apps: $apps"
          # key=value æ ¼å¼
          echo "apps=[$apps]" >> $GITHUB_OUTPUT
          echo "base_path=${{ env.BASE_PATH }}" >> $GITHUB_OUTPUT

  ###########################################
  # æ‰“åŒ…å‘å¸ƒ
  ###########################################
  # æ²¡å¿…è¦ä¸€ä¸ªä¸ªè®¾ç½®ç¯å¢ƒå†æ‰“åŒ…
  package:
    name: æ‰“åŒ…å‘å¸ƒ
    if: ${{ inputs.DO_RELEASE }}
    needs:
      - syntax_check
      - get_apps
      - unittest
    uses: wordsworth-mk/github-runner/.github/workflows/22.package.yml@main

    # ä½¿ç”¨å‰é¢çš„ job çš„è¾“å‡º
    # #### ä¸ç”¨ matrix å¤šä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªä»»åŠ¡è¿›è¡Œæ‰“åŒ…å°±å¯ä»¥äº†
    # strategy:
    #   matrix:
    #     apps: ${{ fromJSON(needs.get_apps.outputs.apps) }}

    with:
      # APPS_PATH: ${{ fromJSON(needs.get_apps.outputs.apps) }}
      DO_RELEASE: ${{ inputs.DO_RELEASE }}
    secrets:
      MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN }}
