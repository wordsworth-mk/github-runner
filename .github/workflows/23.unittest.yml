name: 23. ğŸš¥ è‡ªåŠ¨åŒ–æµ‹è¯•

on:
  workflow_call:
    inputs:
      # ç”¨ä¾‹è·¯å¾„
      CASE_PATH:
        required: true
        type: string

      # ä¾èµ–çš„è½¯ä»¶
      DEPENDENT_BINARY:
        required: true
        type: string

      # è·³è¿‡çš„ pytest ç”¨ä¾‹æ ‡è®°
      NOT_RUN_MARK:
        required: true
        type: string

    # å¯é‡ç”¨æµæ°´çº¿ä¸å¯ä»¥ç›´æ¥è¯»å…¥ secretsï¼Œéœ€è¦ç”±è°ƒç”¨æ–¹ä¼ å…¥ https://www.5axxw.com/questions/content/v8jtsq
    secrets:
      ACTIONS_DEPLOY_KEY:
        required: true
      # å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™æä¾› token ç”¨æ¥æ‹‰å–æœ¬ç§æœ‰ä»“åº“
      MYPY_ACCESS_TOKEN:
        required: false

env:
  ENV_RUN_ENVIRONMENT: pytest
  ENV_INIT_SCRIPT: mypy/env_init.sh

jobs:
  unittest:
    name: å•å…ƒæµ‹è¯•
    strategy:
      matrix:
        python-version: ["3.9"]
        os: [ubuntu-latest]

    runs-on: ${{ matrix.os }}
    env:
      FONT_DIR: mypy/mypy/assets/font
      ALLURE_RESULT_DIR: ".report/allure/result"
      ALLURE_REPORT_DIR: ".report/allure/report"
      ALLURE_HISTORY: ".report/allure/history"

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: è®¾ç½®æ—¶åŒº
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: è®¾ç½® Python ${{ matrix.python-version }} ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v4.2.2
        id: cache
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('mypy/requirements.txt') }}

      - name: å®‰è£…ä¾èµ–ç¨‹åº
        uses: ConorMacBride/install-package@v1.1.0
        with:
          apt: ${{ inputs.DEPENDENT_BINARY }}
          # choco: ${{ inputs.DEPENDENT_BINARY }}

      - name: å®‰è£…å­—ä½“
        run: |
          bash mypy/mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true' # æœªå‘½ä¸­ç¼“å­˜
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}

      - name: å®‰è£…ç¬¬ä¸‰æ–¹æœåŠ¡
        continue-on-error: true
        run: |
          bash mypy/mypy/3party/init.sh

      # --------------------------
      # ä»¥ä¸Šæ­¥éª¤ä¸ run ä¸€è‡´
      # XXX ç”±äºæ¯ä¸ª workflowï¼Œæ¯ä¸ª job éƒ½æ˜¯ä¸åŒçš„ç¯å¢ƒ
      # é™¤éæ”¾åˆ°åŒä¸€ä¸ª job é‡Œï¼Œå¦åˆ™æ— æ³•å¤ç”¨ç¯å¢ƒ
      # --------------------------

      - name: ğŸŸ¢ è‡ªåŠ¨åŒ–æµ‹è¯•
        run: |
          pip install -r mypy/requirements_test.txt > /dev/null 2>&1 && \
          bash mypy/pytest.sh -d ${{ inputs.CASE_PATH }} -g -s "${{ inputs.NOT_RUN_MARK }}"

      ################################################################

      - name: Get Allure history
        uses: actions/checkout@v4
        # è®¿é—®ä»“åº“ç”¨åˆ°çš„ Personal access token
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python
          # NOTICE: æœ¬ä»“åº“å¿…é¡»å­˜åœ¨è¿™ä¸ªåˆ†æ”¯ï¼Œè¿™ä¸ªåˆ†æ”¯ç”¨æ¥å­˜æ”¾ allure æŠ¥å‘Š
          ref: allure-report
          path: ${{ env.ALLURE_HISTORY }}

      # å‘å¸ƒæµ‹è¯•æŠ¥å‘Šåˆ° github page
      - name: Generate allure report action
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: ${{ env.ALLURE_RESULT_DIR }}
          allure_report: ${{ env.ALLURE_REPORT_DIR }}
          allure_history: ${{ env.ALLURE_HISTORY }}
          keep_reports: 10 # Specify the number of previous reports to keep

      # ç”Ÿæˆ pages ä¸”æ¨é€åˆ°æ–‡ä»¶ä»“åº“
      - name: Deploy allure report to gitHub pages action
        uses: peaceiris/actions-gh-pages@v3.9.3
        with:
          # æŠŠç§é’¥æ”¾åˆ°æœ¬ä»“åº“çš„ secrets é‡Œ
          # æŠŠå…¬é’¥æ”¾åˆ°å¯¹ç«¯ä»“åº“è®¾ç½®é‡Œçš„ deploy_key é‡Œ
          # NOTICE: å¿…é¡»æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª key æ˜¯å¦æ­£å¸¸ https://github.com/M-Kepler/M-Kepler.github.io/settings/keys/96146402
          # NOTICE: å¿…é¡»å…ˆæ–°å»ºè¿™ä¸ªåˆ†æ”¯
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          external_repository: M-Kepler/M-Kepler.github.io
          publish_branch: gh-pages
          publish_dir: ${{ env.ALLURE_REPORT_DIR }}
          commit_message: "[githubactions]: Deploy allure report to github page"
